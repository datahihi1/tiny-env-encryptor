#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use Datahihi1\TinyEnv\Encryptor;

$args = $_SERVER['argv'];
$script = array_shift($args);

if (count($args) < 2) {
    echo "TinyEnv Encryptor - A simple tool to encrypt .env values\n\n";
    echo "Usage:\n";
    echo "  {$script} generate-key                     Generate a new encryption key\n";
    echo "  {$script} encrypt <key> <input.env> [output.env] [keys-to-encrypt...]\n\n";
    echo "Examples:\n";
    echo "  {$script} generate-key\n";
    echo "  {$script} encrypt abc123def456 .env .env.encrypted DB_PASSWORD API_SECRET\n";
    exit(exit(1));
}

$command = array_shift($args);

switch ($command) {
    case 'generate-key':
        generateKey();
        break;
    case 'encrypt':
        encryptCommand($args);
        break;
    default:
        die("Unknown command: $command\n");
}

function generateKey()
{
    $key = base64_encode(random_bytes(32));
    echo "Your encryption key (keep it safe!):\n\n";
    echo $key . PHP_EOL . PHP_EOL;
    echo "Add to your .env:\n";
    echo "TINY_ENV_KEY={$key}\n";
}

function encryptCommand(array $args)
{
    if (count($args) < 2) {
        die("Usage: tiny-env-encryptor encrypt <base64-key> <input.env> [output.env] [key1 key2 ...]\n");
    }

    $secretKey = $args[0];
    $inputFile = $args[1];
    $outputFile = $args[2] ?? $inputFile;
    $encryptOnly = array_slice($args, 3);

    if (!file_exists($inputFile)) {
        die("File not found: $inputFile\n");
    }

    $lines = file($inputFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    $variables = [];

    foreach ($lines as $line) {
        if ((strpos(trim($line), '#') === 0) || (strpos($line, '=') === false)) {
            continue;
        }

        [$key, $value] = explode('=', $line, 2);
        $key = trim($key);
        $value = trim($value);

        $value = preg_replace('/^([\'"])(.*)\1$/', '$2', $value);

        $variables[$key] = $value;
    }

    $encryptor = new Encryptor($secretKey);

    $encryptedContent = $encryptor->generate($variables, $encryptOnly);

    file_put_contents($outputFile, $encryptedContent . PHP_EOL);

    echo "Encrypted successfully!\n";
    echo "Input : $inputFile\n";
    echo "Output: $outputFile\n";
    echo "Encrypted keys: " . (empty($encryptOnly) ? "ALL" : implode(', ', $encryptOnly)) . "\n";
}